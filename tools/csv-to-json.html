<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>CSV → JSON</title>
</head>
<body>
  <h1>CSV → JSON</h1>
  <button id="run">Gerar JSON</button>
  <pre id="out" style="white-space:pre-wrap;"></pre>

  <script src="../config.js"></script>
  <script>
    // CSV parser simples (aguenta aspas)
    function parseCsv(text) {
      const rows = [];
      let row = [];
      let cur = "";
      let inQuotes = false;

      for (let i = 0; i < text.length; i++) {
        const c = text[i];
        const next = text[i + 1];

        if (c === '"' && inQuotes && next === '"') { cur += '"'; i++; continue; }
        if (c === '"') { inQuotes = !inQuotes; continue; }

        if (c === "," && !inQuotes) { row.push(cur); cur = ""; continue; }

        if ((c === "\n" || c === "\r") && !inQuotes) {
          if (c === "\r" && next === "\n") i++;
          row.push(cur);
          if (row.some(v => (v || "").trim() !== "")) rows.push(row);
          row = [];
          cur = "";
          continue;
        }
        cur += c;
      }
      row.push(cur);
      if (row.some(v => (v || "").trim() !== "")) rows.push(row);
      return rows;
    }

    function toObj(headers, values) {
      const o = {};
      headers.forEach((h, i) => o[h.trim()] = (values[i] ?? "").trim());
      return o;
    }

    document.getElementById("run").addEventListener("click", async () => {
      const url = CONFIG.DATA_SOURCE; // o teu CSV publicado
      const res = await fetch(url, { cache: "no-store" });
      const text = await res.text();

      const table = parseCsv(text);
      const headers = table[0] || [];
      const dataRows = table.slice(1);

      const json = dataRows
        .filter(r => r.some(v => (v||"").trim() !== ""))
        .map(r => toObj(headers, r))
        .filter(o => (o.name || o.Name || o.Nome || "").trim());

      const out = JSON.stringify(json, null, 2);
      document.getElementById("out").textContent = out;

      // também copia automaticamente para o clipboard (se o browser permitir)
      try { await navigator.clipboard.writeText(out); } catch(e){}
    });
  </script>
</body>
</html>
